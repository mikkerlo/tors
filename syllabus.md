## Модель распределенной системы

_\"All models are wrong, but some are useful\"_

- Модель распределенной системы, асинхронность узлов и сети
- Кварцевые и атомные часы, skew и drift, значения ppm для разных типов часов
- Применения часов: failure detection и ordering
- Невозможность синхронизации часов без дрейфа в синхронной системе, невозможность обнаружить асимметрию сети
- GPS и сихронизация часов, навигационные уравнения, релятевистские эффекты
- Google TrueTime, Google Sundial

## Репликация и линеаризуемость. Алгоритм ABD.

- Репликация и асинхронная модель, наблюдаемое поведение, распределенная система как конкурентный объект
- Конкурентные истории, последовательные истории и последовательная спецификация, модели согласованности, линеаризуемось
- Интуиция за линеаризуемостью: причинность за пределами системы, упорядочивание апдейтов внутри системы, согласованность причинности и упорядочивания апдейтов через физическое время
- Задача репликации регистра. Случай 1-го писател], кворумные операции, нарушение линеаризуемости
- Синхронная кворумная запись в чтении, аналогия с lock-free, доказательство, 
- Сложность в переходе к нескольким писателям, упорядочивание записей
- Выбор таймстемпов с помощью дополнительной фазы кворумного чтения
- Системы кворумов
- Рестарты узлов и персистентное состояние
- Переконфигурации
- Попытки обобщения на RMW-операции

## State Machine Replication, Atomic Broadcast, Consensus

\"_There are only two hard problems in distributed systems:  2. Exactly-once delivery 1. Guaranteed order of messages 2. Exactly-once delivery_\"

- Atomic (Totally Ordered) Broadcast и его свойства
- AB как транспорт команд, общая схема линеаризуемой репликации произовольного автомата
- Доказательство линеаризуемости
- Нетривиальные моменты
  * Недетерминизм и его источники: время, хэш-функции и итерация по хэш-таблицам, обновление версий
  * Таймауты на клиенте и семантика exactly-once
  * Read-only операции
  * Большие автоматы, шардирование, composability линеаризуемости, транзакции
- Эквивалентность AB и Consensus, реализация AB с помощью RB + серии Consensus
- Свойства safety и liveness, примеры, пересечение safety и liveness свойств

## Impossibility of Consensus

- Отказоустойчивость репликации определяется отказоустойчивостью Consensus
- Граница $`n > 2f`$ для произвольного алгоритма, tradeoff agreement / termination, последствия для AB
- FLP теорема для детерминированных процессов в асинхронной системе, последствия для репликации
- Consensus и Failure Detection, leader election - weakest failure detector.

## Single-Decree Paxos

_\"The Paxos algorithm, when presented in plain English, is very simple.\"_ – Leslie Lamport, _Paxos Made Simple_

- История статьи Part Time Parliament, греки, Paxos Made Simple
- Описание алгоритма: протокол, роли, ballot-ы, фазы, раунды
- Разбор основных сценариев исполнения
- Выбор значения: контрпример для случая, когда большинство аксепторов приняли одно _значение_
- Выбор значения: доказательство корректности для выбора proposal-а
- Paxos и FLP, сценарий dueling proposers, разрушение симметрии:
- Как узнать выбранное значение
- Рестарты и персистентное состояние аксепторов

## Multi-Paxos

- Материализация порядка из AB в виде реплицированного лога, фреймворк SMR
- Алгоритмы репликации лога: Multi-Paxos, RAFT, ZAB, разница
- Наивный Multi-Paxos, независимые инстансы Single-Decree Paxos в каждом слоте 
- Состояния лога: _empty_/_accepted_/_committed_ слоты, дырки
- Выборы лидера, алгоритм Лэмпорта с максимальным id, взаимодействие клиента с лидером: редиректы и кэширование лидера на клиенте
- Главная оптимизация: пайплайнинг, в пределе - один RTT на коммит команды
- Захват всего суффикса лога одним _Prepare_
- Физический смысл фаз / сущностей из алгоритма Single-decree Paxos
- Single-decree Paxos - как сценарий конкуренции лидеров в Multi-Paxos.
- Финализация команд в логе

## RAFT

## Paxos Made Live

_\"In Theory There Is No Difference Between Theory and Practice, While In Practice There Is.\"_

- Выбор числа реплик
- Failure Domains, tradeoff между отказоустойчивостью и латентностью
- Переконфигурации: остановка RSM, наивный подход, служебная команда в реплицируемом логе, alpha-метод Лэмпорта в Multi-Paxos
- Read-only операции: stale reads (+только с лидера), опрос кворума, leader leases и физическое время
- Батчинг
- Компактификация лога команд и снэпшоттинг: персистентность, CoW и fork, fuzzy snapshots в ZAB
- Физическое представление лога команд в fs: сегменты, преаллокация
- Ограничения дизайна с выделенным лидером

## Distributed Transactions

_\"Transactions are hard. Distributed transactions are harder. Distributed transactions over the WAN are final boss hardness.\"_ – Andy Pavlo

### Общая теория

- Мотивация к транзакциям: шардирование KV (на примере BigTable), запись на границе чанков в GFS
- Транзакции, ACID
- Линеаризуемое хранилище, планировщик, расписания, сериализуемость
- View- и conflict- serializability, граф конфликтов, критерий конфликтной сериализуемости
- Двухфазные блокировки (Strict 2PL), док-во корректности, дедлоки, прогресс
- Snapshot Isolation, версионированное хранилище, аномалия write skew, реализация: двухфазный атомарный коммит, иммутабельные снапшоты

### Google Spanner

- Транзакции в Spanner = 2PL + SI
- Согласованность commit order 2PL и timestamp order SI через физическое время
- Идея: timestamp = now внутри интервала владения блокировками в 2PL
- TrueTime, реализация и свойства, commit wait
- Атомарный коммит: 2PC
- Неблокирующие чтения и полное правило выбора временной метки для коммита

### Calvin

- Декомпозиция задачи: упорядочивание транзакций и их исполнение
- Неотказоустойчивый дизайн: sequencer и шарды
- Отказоустойчивый sequencer: RSM
- Масштабируемый sequencer: шардирование по хэшу, медиаторы
- Исполнение плана транзакций: deterministic locking, реализация
- Ограничения: детерминизм транзакций, известный заранее read/write set
- Произвольные интерактивные транзакции через детерминированных

### Сравнение транзакций из Spanner / Calvin


## Формальные методы, TLA+

_\"Weeks of debugging can save you hours of TLA+\"_

- Верификация распределенных систем. Инструменты: дизайн-доки и дизайн-ревью, псевдокод, сантитайзеры, fault injection
- Пропущенное звено: формальная спецификация. Спецификация = система + свойства.
- Model checking
- Граф состояний, траектории
- Специфика конкурентных систем, свойства safety и liveness
- FOL для утверждений про состояния, линейная темпоральная логика (LTL) для утверждений про исполнения
- TLA+, actions, stuttering
- Спецификация для Single-Decree Paxos, рецепты для спецификации распределенных алгоритмов

## Byzantine Faults

- Модель византийских сбоев, причины, почему алгоритмы RAFT/MultiPaxos не учитывают ее
- Необходимость аутентификации, цифровые подписи
- Граница $`n > 3f`$
- Вероятностный алгоритм Ben-Or для задачи византийского консенсуса

## PBFT

- Public Key Infrastructure
- Взаимодействие клиента с системой в византийской модели
- История: VR, primary/backups, views, репликация и смена эпохи
- Трудности с византийским primary: умалчивание команд, переупорядочивание команд
- Репликация команд: фазы _PrePrepare_, _Prepare_, кворумный _Prepare_-сертификат
- Коммит команды и смена эпохи
- Протокол перехода через эпоху, _ViewChange_ и _NewView_, кворумные сертификаты
- Условие коммита команды, фаза _Commit_
- Коды аутентификации сообщений (MAC) против цифровых подписей, non-repudiation 
- Компактификация лога и чекпоинты, кворумные сертификаты для чекпоинтов

## Bitcoin, Nakamoto Consensus

- Общая схема электронных денег: транзакции _mint_ и _spend_, адресация хэшами, проверка цифровых подписей
- Проблема double spending, лог транзакций, задача репликация лога в византийской модели
- Централизация: банк (поддержание лога транзакций, эмиссия монет), certification authority
- Децентрализация, публичность и псевдонимы, адресация через публичные ключи
- Блокчейн
- Коммуникация: gossiping
- Добавление блока в блокчейн: децентрализованная лотерея с помощью PoW
- nonce как криптографическое доказательство
- Лотерея и liveness в византийской модели
- Форки и голосование за ветку с помощью майнинга
- Finality, атака 51%
- Мотивация майнеров и эмиссия монет, coinbase транзакции, экономическая поддержка консенсуса
- Блокчейн через линзы классических алгоритмов репликации, сравнение с PBFT:
  - Голосования идентификаторами (кворумы) и вычислительными мощностями
  - Статическая конфигурация и возможность коммита, динамическая конфигурация и 
  - Лотерея через PoW как rotating primary
  - Криптографические сертификаты в Bitcoin и PBFT

--- 

- ASIC, пулы, стратегия selfish mining
- Шардирование и транзакции между блокчейнами (atomic swaps), хэш-локи и тайм-локи


## HotStuff / LibraBFT = Bitcoin + PBFT

- Оптимизация коммуникации в PBFT: mesh -> star через primary, кворумный сертификат
- Формальный взгляд на фазы PBFT: QC, QC-of-QC и т.д.
- Смена primary в каждом слоте.
- Реализация конвейера с помощью hash pointers
- Алгоритм LibraBFT, правила голосования, доказательство корректности
